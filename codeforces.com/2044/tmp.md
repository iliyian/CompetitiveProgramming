共有 $n$关，每次挑战有 $p$ 的概率通过, $1-p$ 的概率失败

抽象出一个二维平面,点 $(i,j)$ 代表现在在关卡 $i$ ,手上还有 $j$ 枚金币的状态, $f_{i,j}$ 代表从该状态到达终点的期望步数

每步有p的概率走到点 $(i+1,j)$ ,有另 $1-p$ 的概率走到点 $(i,j-1)$ ,走到 $i=n$ 时停止;

特别地, $f_{i,-1}$ 即 $f_{0,0}$ ,代表失败且没有金币后回到原点

---
$p=1$ 时直接特判。

我们可以将全过程分为"第一次失败且没有金币"(事件 $S$)之前和之后(如果事件 $S$ 没有发生,"之后"就不存在):

---
对于"之前",研究每个状态[点 $(i \in [0,n),j \in [0,m])$ ]被经过(事件 $S$ 之后不算)的概率:

它们只会被经过一次,且总需要花1步走出去,则"之前"这部分的期望步数为所有点被经过概率的总和,设其为 $Ans1$

设 $g_{i,j}$ 为:点 $B$ 比点 $A$ 横坐标大 $i$ ,纵坐标小 $j$ 时,从点 $A$ 开始按规则经过点 $B$ 的概率,另设 $G_j=\sum_{i=0}^{n-1} g_{i,j}$

有 $Ans1=\sum_{i=0}^{n-1} \sum_{j=0}^m g_{i-0,m-j}=\sum_{i=0}^{n-1} \sum_{j=0}^m g_{i,j}=\sum_{j=0}^m G_j$
<br><br><br>
对于"之后",研究在每个 $j=0$ 的点进入事件 $S$ 的概率,有 $Ans2=G(i) \ast (1-p) \ast f_{0,0}$
<br><br><br>
需要的 $Ans=Ans1+Ans2$ ,以下研究如何计算 $f(0,0)$ 和各 $P(j)$

---
**(a).计算 $f_{0,0}$:**

另设 $h_i$ 为从关卡 $0$ 走到 $i$ 的期望步数, $f_{0,0}=h_n$

$h_0=0$ ,考虑尝试从关卡 $i$ 走到 $i+1$ 的期望步数,有:

$h_{i+1}-h_i=p \ast 0(成功)+(1-p) \ast h_{i+1}(失败,从0开始走到i+1)+1(总得走一步的)$

得 $h_{i+1}=\frac{h_i+1}{p},\frac{h_{i+1}-1}{p-1}=\frac{1}{p} \ast \frac{h_i-1}{p-1},h_i=(h_0+\frac{1}{1-p}) \ast {(\frac{1}{p})}^i-\frac{1}{1-p}=\frac{{(\frac{1}{1-p})^i}-1}{1-p}$

则 $F_{0,0}=h_n=\frac{{(\frac{1}{1-p})^i}-1}{1-p}$

**(b).计算 $G_j$:**

$g_{i,j}=C_{i+j}^i \ast p^i \ast (1-p)^j$ ,直接算 $G_j$ 是困难的...

不过对于 $j=0$ , $g_{i,0}=p^i,G_0=\frac{p^n-1}{p-1}$ 显然

考虑走到点 $(i,j)$ 的前一步,有 $(i>0)$ :

$g_{i,j}=p \ast g_{i-1,j}+(1-p) \ast g_{i,j-1}$

$\sum_{i=0}^{n-1}g_{i,j}=p \ast \sum_{i=0}^{n-1}g_{i-1,j}+(1-p) \ast \sum_{i=0}^{n-1}g_{i,j-1}$

$G_j=p \ast (G_j-g_{n-1,j}+g_{-1,j})+(1-p) \ast G_{j-1},G_j=G_{j-1}-\frac{p \ast g_{n-1,j}}{1-p}$

$g_{n-1,j}$ 之间的递推只需若干次乘除, $G_j$ 也是。

---
把以上所有东西结合起来就可以算出结果了!

代码中的 $A$ 即 $-\frac{p}{1-p}$ , $sp$ 即 $(1-p)F(0,0)=(\frac{1}{p})^n-1$ , $Ans2=P(m) \ast sp$ ;

循环中 $i=j$ 时的 $dot$ 即 $g_{n-1,j}$ , $sum$ 即 $G_j$ , $ans$ 即 $\sum_{j=0}^m G_j$ 。